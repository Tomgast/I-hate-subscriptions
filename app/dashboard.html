<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - CashControl</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="icon" href="/favicon.ico" />
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900">
    <!-- Navigation -->
    <nav class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex items-center space-x-2">
                        <svg class="h-8 w-8 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                        </svg>
                        <span class="font-bold text-xl text-gray-900 dark:text-white">CashControl</span>
                    </div>
                    <div class="hidden md:ml-6 md:flex md:space-x-8">
                        <a href="/app/dashboard.html" class="border-primary-500 text-gray-900 dark:text-white inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Dashboard
                        </a>
                        <a href="/app/subscriptions.html" class="border-transparent text-gray-500 dark:text-gray-400 hover:border-gray-300 hover:text-gray-700 dark:hover:text-gray-300 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Subscriptions
                        </a>
                        <a href="/app/settings.html" class="border-transparent text-gray-500 dark:text-gray-400 hover:border-gray-300 hover:text-gray-700 dark:hover:text-gray-300 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Settings
                        </a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="dark-mode-toggle" class="p-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                        <i data-lucide="moon" class="h-5 w-5"></i>
                    </button>
                    <div id="user-info" class="flex items-center space-x-3">
                        <div class="h-8 w-8 bg-primary-600 rounded-full flex items-center justify-center">
                            <span id="user-initials" class="text-white text-sm font-medium">U</span>
                        </div>
                        <span id="user-name" class="text-sm font-medium text-gray-700 dark:text-gray-300">Loading...</span>
                    </div>
                    <button id="logout-btn" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                        <i data-lucide="log-out" class="h-5 w-5"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Loading State -->
        <div id="loading" class="flex justify-center items-center h-64">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600"></div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboard-content" class="hidden">
            <!-- Header -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Dashboard</h1>
                    <p class="text-gray-600 dark:text-gray-400 mt-1">
                        Track and manage all your subscriptions
                    </p>
                </div>
                <div class="flex gap-3 mt-4 sm:mt-0">
                    <div class="relative">
                        <button id="export-btn" class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 dark:hover:bg-gray-600 flex items-center gap-2">
                            <i data-lucide="download" class="h-4 w-4"></i>
                            Export
                            <span id="export-pro-badge" class="text-xs bg-primary-600 text-white px-1 rounded ml-1 hidden">PRO</span>
                        </button>
                        <div id="export-menu" class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg border border-gray-200 dark:border-gray-700 z-10 hidden">
                            <div class="py-1">
                                <button class="export-option block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" data-format="csv">
                                    Export as CSV
                                </button>
                                <button class="export-option block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" data-format="pdf">
                                    Export as PDF
                                </button>
                                <button class="export-option block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" data-format="json">
                                    Export as JSON
                                </button>
                            </div>
                        </div>
                    </div>
                    <button id="bulk-import-btn" class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 dark:hover:bg-gray-600 flex items-center gap-2">
                        <i data-lucide="upload" class="h-4 w-4"></i>
                        Bulk Import
                        <span id="import-pro-badge" class="text-xs bg-primary-600 text-white px-1 rounded ml-1 hidden">PRO</span>
                    </button>
                    <button id="bank-scan-btn" class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 dark:hover:bg-gray-600 flex items-center gap-2">
                        <i data-lucide="credit-card" class="h-4 w-4"></i>
                        <span id="bank-scan-text">Scan Bank</span>
                        <span id="bank-pro-badge" class="text-xs bg-primary-600 text-white px-1 rounded ml-1 hidden">PRO</span>
                    </button>
                    <a href="/app/subscriptions/new.html" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                        <i data-lucide="plus" class="h-4 w-4"></i>
                        Add Subscription
                    </a>
                </div>
            </div>

            <!-- Success Message -->
            <div id="success-message" class="mb-6 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg hidden">
                <div class="flex items-center">
                    <i data-lucide="check-circle" class="h-5 w-5 text-green-400 mr-3"></i>
                    <p id="success-text" class="text-green-800 dark:text-green-200"></p>
                    <button id="close-success" class="ml-auto text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-200">
                        ×
                    </button>
                </div>
            </div>

            <!-- User Account Status -->
            <div id="account-status" class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6 mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                            Account: <span id="account-name">Loading...</span>
                        </h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">
                            <span id="account-email">Loading...</span>
                            <span id="pro-since" class="ml-2 text-xs text-green-600 dark:text-green-400 hidden"></span>
                        </p>
                    </div>
                    <div class="flex items-center gap-3">
                        <span id="account-badge" class="px-3 py-1 rounded-full text-sm font-medium">Loading...</span>
                        <a id="upgrade-btn" href="/app/pricing.html" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg text-sm font-medium hidden">
                            Upgrade to Pro
                        </a>
                    </div>
                </div>
            </div>

            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white dark:bg-gray-800 overflow-hidden shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <i data-lucide="credit-card" class="h-6 w-6 text-primary-600"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Active Subscriptions</dt>
                                    <dd id="total-count" class="text-lg font-medium text-gray-900 dark:text-white">0</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 overflow-hidden shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <i data-lucide="calendar" class="h-6 w-6 text-green-600"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Monthly Total</dt>
                                    <dd id="monthly-total" class="text-lg font-medium text-gray-900 dark:text-white">€0.00</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 overflow-hidden shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <i data-lucide="trending-up" class="h-6 w-6 text-blue-600"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Yearly Total</dt>
                                    <dd id="yearly-total" class="text-lg font-medium text-gray-900 dark:text-white">€0.00</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 overflow-hidden shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <i data-lucide="bar-chart" class="h-6 w-6 text-purple-600"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Average Monthly</dt>
                                    <dd id="average-monthly" class="text-lg font-medium text-gray-900 dark:text-white">€0.00</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search and Filter Bar -->
            <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4 mb-6">
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="flex-1">
                        <div class="relative">
                            <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"></i>
                            <input id="search-input" type="text" placeholder="Search subscriptions..." class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button id="show-upcoming-btn" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600">
                            <i data-lucide="clock" class="h-4 w-4 mr-2"></i>
                            Upcoming
                        </button>
                        <button id="filter-btn" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600">
                            <i data-lucide="filter" class="h-4 w-4 mr-2"></i>
                            Filter
                        </button>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Spending Chart -->
                <div class="bg-white dark:bg-gray-800 overflow-hidden shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
                    <div class="px-4 py-5 sm:p-6">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4">Monthly Spending Trend</h3>
                        <canvas id="spending-chart" width="400" height="200"></canvas>
                    </div>
                </div>

                <!-- Category Breakdown -->
                <div class="bg-white dark:bg-gray-800 overflow-hidden shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
                    <div class="px-4 py-5 sm:p-6">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4">Spending by Category</h3>
                        <canvas id="category-chart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- Subscriptions List -->
            <div class="bg-white dark:bg-gray-800 shadow-sm overflow-hidden sm:rounded-lg border border-gray-200 dark:border-gray-700">
                <div class="px-4 py-5 sm:px-6 flex justify-between items-center">
                    <div>
                        <h3 id="subscriptions-title" class="text-lg leading-6 font-medium text-gray-900 dark:text-white">Your Subscriptions</h3>
                        <p id="subscriptions-subtitle" class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">Manage all your active subscriptions</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <span id="subscription-count" class="text-sm text-gray-500 dark:text-gray-400">0 subscriptions</span>
                    </div>
                </div>
                <div id="subscriptions-list" class="divide-y divide-gray-200 dark:divide-gray-700">
                    <!-- Subscriptions will be loaded here -->
                </div>
                <div id="no-subscriptions" class="px-4 py-12 text-center hidden">
                    <i data-lucide="credit-card" class="h-12 w-12 text-gray-400 mx-auto mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No subscriptions yet</h3>
                    <p class="text-gray-500 dark:text-gray-400 mb-4">Start tracking your subscriptions to get insights into your spending.</p>
                    <a href="/app/subscriptions/new.html" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
                        Add Your First Subscription
                    </a>
                </div>
            </div>
        </div>

        <!-- Error State -->
        <div id="error-state" class="hidden text-center py-12">
            <i data-lucide="alert-circle" class="h-12 w-12 text-red-400 mx-auto mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Something went wrong</h3>
            <p class="text-gray-500 dark:text-gray-400 mb-4">We couldn't load your dashboard data.</p>
            <button id="retry-btn" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
                Try Again
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Global state
        let currentUser = null;
        let subscriptions = [];
        let stats = {};
        let showUpcoming = false;
        let searchQuery = '';
        let spendingChart = null;
        let categoryChart = null;

        // Initialize Lucide icons
        lucide.createIcons();

        // Authentication functions
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/session.php');
                if (response.ok) {
                    const user = await response.json();
                    return user;
                }
                return null;
            } catch (error) {
                console.error('Auth check failed:', error);
                return null;
            }
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout.php', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                console.error('Logout failed:', error);
                window.location.href = '/';
            }
        }

        // Dashboard data functions
        async function loadDashboardData() {
            try {
                const [subscriptionsRes, statsRes] = await Promise.all([
                    fetch('/api/subscriptions/list.php'),
                    fetch('/api/subscriptions/stats.php')
                ]);

                if (subscriptionsRes.ok) {
                    subscriptions = await subscriptionsRes.json();
                }

                if (statsRes.ok) {
                    stats = await statsRes.json();
                }

                updateUI();
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
                showError();
            }
        }

        // UI update functions
        function updateUI() {
            updateStats();
            updateCharts();
            updateSubscriptionsList();
            updateAccountStatus();
            hideLoading();
        }

        function updateStats() {
            document.getElementById('total-count').textContent = stats.totalCount || 0;
            document.getElementById('monthly-total').textContent = `€${(stats.monthlyTotal || 0).toFixed(2)}`;
            document.getElementById('yearly-total').textContent = `€${(stats.yearlyTotal || 0).toFixed(2)}`;
            document.getElementById('average-monthly').textContent = `€${(stats.averageMonthly || 0).toFixed(2)}`;
        }

        function updateAccountStatus() {
            if (!currentUser) return;

            document.getElementById('account-name').textContent = currentUser.name || 'User';
            document.getElementById('account-email').textContent = currentUser.email || '';
            
            const badge = document.getElementById('account-badge');
            const upgradeBtn = document.getElementById('upgrade-btn');
            const proSince = document.getElementById('pro-since');

            if (currentUser.isPaid) {
                badge.textContent = 'Pro Account';
                badge.className = 'px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
                upgradeBtn.classList.add('hidden');
                
                if (currentUser.paymentDate) {
                    proSince.textContent = `Pro since ${new Date(currentUser.paymentDate).toLocaleDateString()}`;
                    proSince.classList.remove('hidden');
                }
                
                // Hide pro badges
                document.querySelectorAll('[id$="-pro-badge"]').forEach(badge => badge.classList.add('hidden'));
            } else {
                badge.textContent = 'Free Account';
                badge.className = 'px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200';
                upgradeBtn.classList.remove('hidden');
                
                // Show pro badges
                document.querySelectorAll('[id$="-pro-badge"]').forEach(badge => badge.classList.remove('hidden'));
            }

            // Update user initials
            const initials = (currentUser.name || 'U').split(' ').map(n => n[0]).join('').toUpperCase();
            document.getElementById('user-initials').textContent = initials;
        }

        function updateCharts() {
            updateSpendingChart();
            updateCategoryChart();
        }

        function updateSpendingChart() {
            const ctx = document.getElementById('spending-chart').getContext('2d');
            
            if (spendingChart) {
                spendingChart.destroy();
            }

            const monthlyData = stats.monthlySpending || [];
            const labels = monthlyData.map(item => item.month);
            const data = monthlyData.map(item => item.amount);

            spendingChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Monthly Spending',
                        data: data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '€' + value.toFixed(0);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateCategoryChart() {
            const ctx = document.getElementById('category-chart').getContext('2d');
            
            if (categoryChart) {
                categoryChart.destroy();
            }

            const categoryData = stats.categoryBreakdown || [];
            const labels = categoryData.map(item => item.category);
            const data = categoryData.map(item => item.amount);
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'];

            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateSubscriptionsList() {
            const container = document.getElementById('subscriptions-list');
            const noSubscriptions = document.getElementById('no-subscriptions');
            const subscriptionCount = document.getElementById('subscription-count');
            
            let filteredSubs = subscriptions;
            
            // Apply search filter
            if (searchQuery) {
                filteredSubs = filteredSubs.filter(sub => 
                    sub.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    sub.category.toLowerCase().includes(searchQuery.toLowerCase())
                );
            }
            
            // Apply upcoming filter
            if (showUpcoming) {
                const thirtyDaysFromNow = new Date();
                thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
                
                filteredSubs = filteredSubs.filter(sub => {
                    const renewalDate = new Date(sub.nextBillingDate);
                    return renewalDate <= thirtyDaysFromNow;
                });
                
                document.getElementById('subscriptions-title').textContent = 'Upcoming Renewals';
                document.getElementById('subscriptions-subtitle').textContent = 'Subscriptions renewing in the next 30 days';
            } else {
                document.getElementById('subscriptions-title').textContent = 'Your Subscriptions';
                document.getElementById('subscriptions-subtitle').textContent = 'Manage all your active subscriptions';
            }
            
            subscriptionCount.textContent = `${filteredSubs.length} subscription${filteredSubs.length !== 1 ? 's' : ''}`;
            
            if (filteredSubs.length === 0) {
                container.innerHTML = '';
                noSubscriptions.classList.remove('hidden');
            } else {
                noSubscriptions.classList.add('hidden');
                container.innerHTML = filteredSubs.map(sub => createSubscriptionCard(sub)).join('');
            }
        }

        function createSubscriptionCard(subscription) {
            const renewalDate = new Date(subscription.nextBillingDate);
            const daysUntilRenewal = Math.ceil((renewalDate - new Date()) / (1000 * 60 * 60 * 24));
            
            let renewalText = '';
            let renewalClass = '';
            
            if (daysUntilRenewal < 0) {
                renewalText = 'Overdue';
                renewalClass = 'text-red-600';
            } else if (daysUntilRenewal === 0) {
                renewalText = 'Due today';
                renewalClass = 'text-red-600';
            } else if (daysUntilRenewal <= 7) {
                renewalText = `Due in ${daysUntilRenewal} day${daysUntilRenewal !== 1 ? 's' : ''}`;
                renewalClass = 'text-orange-600';
            } else {
                renewalText = `Due in ${daysUntilRenewal} days`;
                renewalClass = 'text-gray-600 dark:text-gray-400';
            }

            return `
                <div class="px-4 py-4 flex items-center justify-between hover:bg-gray-50 dark:hover:bg-gray-700">
                    <div class="flex items-center space-x-4">
                        <div class="flex-shrink-0">
                            <div class="h-10 w-10 bg-primary-100 dark:bg-primary-900 rounded-lg flex items-center justify-center">
                                <span class="text-primary-600 dark:text-primary-400 font-semibold text-sm">
                                    ${subscription.name.substring(0, 2).toUpperCase()}
                                </span>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 dark:text-white truncate">
                                ${subscription.name}
                            </p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">
                                ${subscription.category} • ${renewalText}
                            </p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <p class="text-sm font-medium text-gray-900 dark:text-white">
                                €${subscription.price.toFixed(2)}
                            </p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">
                                ${subscription.billingCycle}
                            </p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editSubscription('${subscription.id}')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                <i data-lucide="edit" class="h-4 w-4"></i>
                            </button>
                            <button onclick="deleteSubscription('${subscription.id}')" class="text-gray-400 hover:text-red-600">
                                <i data-lucide="trash-2" class="h-4 w-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Event handlers
        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('dashboard-content').classList.add('hidden');
            document.getElementById('error-state').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('dashboard-content').classList.remove('hidden');
            document.getElementById('error-state').classList.add('hidden');
        }

        function showError() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('dashboard-content').classList.add('hidden');
            document.getElementById('error-state').classList.remove('hidden');
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            const successText = document.getElementById('success-text');
            successText.textContent = message;
            successDiv.classList.remove('hidden');
            
            setTimeout(() => {
                successDiv.classList.add('hidden');
            }, 5000);
        }

        // Action functions
        async function handleExport(format) {
            if (!currentUser.isPaid) {
                window.location.href = '/app/pricing.html';
                return;
            }
            
            try {
                const response = await fetch(`/api/subscriptions/export.php?format=${format}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `subscriptions.${format}`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                }
            } catch (error) {
                console.error('Export failed:', error);
                alert('Export failed. Please try again.');
            }
        }

        async function handleBankScan() {
            if (!currentUser.isPaid) {
                alert('Bank scanning is a premium feature. Please upgrade to Pro to access this feature.');
                return;
            }
            
            document.getElementById('bank-scan-text').textContent = 'Connecting...';
            document.getElementById('bank-scan-btn').disabled = true;
            
            try {
                const response = await fetch('/api/bank-providers/link-token.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider: 'truelayer', countryCode: 'GB' })
                });
                
                if (response.ok) {
                    const { authUrl } = await response.json();
                    window.location.href = authUrl;
                } else {
                    throw new Error('Failed to create bank connection');
                }
            } catch (error) {
                console.error('Bank scan error:', error);
                alert('Failed to connect to bank. Please try again.');
            } finally {
                document.getElementById('bank-scan-text').textContent = 'Scan Bank';
                document.getElementById('bank-scan-btn').disabled = false;
            }
        }

        function editSubscription(id) {
            window.location.href = `/app/subscriptions/edit.html?id=${id}`;
        }

        async function deleteSubscription(id) {
            if (!confirm('Are you sure you want to delete this subscription?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/subscriptions/delete.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
                
                if (response.ok) {
                    showSuccess('Subscription deleted successfully');
                    loadDashboardData();
                } else {
                    throw new Error('Failed to delete subscription');
                }
            } catch (error) {
                console.error('Delete failed:', error);
                alert('Failed to delete subscription. Please try again.');
            }
        }

        // Dark mode toggle
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('darkMode', isDark);
            
            const icon = document.querySelector('#dark-mode-toggle i');
            icon.setAttribute('data-lucide', isDark ? 'sun' : 'moon');
            lucide.createIcons();
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            // Check for dark mode preference
            if (localStorage.getItem('darkMode') === 'true') {
                document.documentElement.classList.add('dark');
                const icon = document.querySelector('#dark-mode-toggle i');
                icon.setAttribute('data-lucide', 'sun');
            }
            
            // Check authentication
            currentUser = await checkAuth();
            if (!currentUser) {
                window.location.href = '/app/auth/signin.html';
                return;
            }
            
            // Update user info
            document.getElementById('user-name').textContent = currentUser.name || 'User';
            
            // Check for success messages from URL params
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('bank_connected') === 'success') {
                showSuccess(`Successfully connected to ${urlParams.get('provider')?.toUpperCase()}! European bank scanning is now ready.`);
                window.history.replaceState({}, '', window.location.pathname);
            } else if (urlParams.get('upgraded') === 'true') {
                showSuccess('Account successfully upgraded to PRO! All premium features are now available.');
                window.history.replaceState({}, '', window.location.pathname);
            }
            
            // Load dashboard data
            await loadDashboardData();
            
            // Event listeners
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('retry-btn').addEventListener('click', loadDashboardData);
            document.getElementById('dark-mode-toggle').addEventListener('click', toggleDarkMode);
            
            // Export menu
            document.getElementById('export-btn').addEventListener('click', function() {
                document.getElementById('export-menu').classList.toggle('hidden');
            });
            
            document.querySelectorAll('.export-option').forEach(btn => {
                btn.addEventListener('click', function() {
                    handleExport(this.dataset.format);
                    document.getElementById('export-menu').classList.add('hidden');
                });
            });
            
            // Other buttons
            document.getElementById('bank-scan-btn').addEventListener('click', handleBankScan);
            document.getElementById('bulk-import-btn').addEventListener('click', function() {
                if (!currentUser.isPaid) {
                    window.location.href = '/app/pricing.html';
                    return;
                }
                window.location.href = '/app/subscriptions/import.html';
            });
            
            // Search and filter
            document.getElementById('search-input').addEventListener('input', function() {
                searchQuery = this.value;
                updateSubscriptionsList();
            });
            
            document.getElementById('show-upcoming-btn').addEventListener('click', function() {
                showUpcoming = !showUpcoming;
                this.classList.toggle('bg-primary-600');
                this.classList.toggle('text-white');
                updateSubscriptionsList();
            });
            
            // Success message close
            document.getElementById('close-success').addEventListener('click', function() {
                document.getElementById('success-message').classList.add('hidden');
            });
            
            // Click outside to close export menu
            document.addEventListener('click', function(event) {
                const exportBtn = document.getElementById('export-btn');
                const exportMenu = document.getElementById('export-menu');
                if (!exportBtn.contains(event.target) && !exportMenu.contains(event.target)) {
                    exportMenu.classList.add('hidden');
                }
            });
            
            // Initialize icons
            lucide.createIcons();
        });
    </script>
</body>
</html>
