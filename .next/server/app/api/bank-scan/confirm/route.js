(()=>{var e={};e.id=144,e.ids=[144],e.modules={72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{"use strict";e.exports=require("assert")},78893:e=>{"use strict";e.exports=require("buffer")},84770:e=>{"use strict";e.exports=require("crypto")},17702:e=>{"use strict";e.exports=require("events")},32615:e=>{"use strict";e.exports=require("http")},35240:e=>{"use strict";e.exports=require("https")},98216:e=>{"use strict";e.exports=require("net")},68621:e=>{"use strict";e.exports=require("punycode")},86624:e=>{"use strict";e.exports=require("querystring")},76162:e=>{"use strict";e.exports=require("stream")},82452:e=>{"use strict";e.exports=require("tls")},17360:e=>{"use strict";e.exports=require("url")},21764:e=>{"use strict";e.exports=require("util")},71568:e=>{"use strict";e.exports=require("zlib")},58359:()=>{},93739:()=>{},64167:(e,r,t)=>{"use strict";t.r(r),t.d(r,{originalPathname:()=>h,patchFetch:()=>y,requestAsyncStorage:()=>f,routeModule:()=>m,serverHooks:()=>x,staticGenerationAsyncStorage:()=>g});var s={};t.r(s),t.d(s,{GET:()=>d,POST:()=>p});var a=t(49303),i=t(88716),n=t(60670),o=t(87070),u=t(75571),l=t(95456);let c=new Map;async function p(e){try{let r=await (0,u.getServerSession)(l.Lz);if(!r?.user?.email)return o.NextResponse.json({error:"Unauthorized"},{status:401});let{confirmedSubscriptions:t}=await e.json();if(!t||!Array.isArray(t))return o.NextResponse.json({error:"Invalid subscription data"},{status:400});let s=r.user.email,a=[],i=c.get(s)||[];for(let e of t){let r={id:`scan-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,user_id:s,name:e.merchant_name,description:"Automatically detected from bank transactions",cost:e.amount,currency:"USD",billing_cycle:"yearly"===e.frequency?"yearly":"monthly",next_billing_date:e.next_billing_date,status:"active",category:e.category,website_url:e.website_url||"",logo_url:e.logo_url||"",notes:`Detected with ${Math.round(100*e.confidence)}% confidence from ${e.transactions.length} transactions`,reminder_days:3,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),source:"bank_scan"};i.some(e=>e.name.toLowerCase()===r.name.toLowerCase()&&.01>Math.abs(e.cost-r.cost))||(i.push(r),a.push(r))}return c.set(s,i),o.NextResponse.json({success:!0,message:`Successfully added ${a.length} subscriptions`,addedSubscriptions:a,totalSubscriptions:i.length})}catch(e){return console.error("Confirm subscriptions error:",e),o.NextResponse.json({error:"Failed to add subscriptions",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}async function d(e){try{let e=await (0,u.getServerSession)(l.Lz);if(!e?.user?.email)return o.NextResponse.json({error:"Unauthorized"},{status:401});let r=e.user.email,t=c.get(r)||[];return o.NextResponse.json({subscriptions:t,total:t.length,bankScanned:t.filter(e=>"bank_scan"===e.source).length})}catch(e){return console.error("Get subscriptions error:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}let m=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/bank-scan/confirm/route",pathname:"/api/bank-scan/confirm",filename:"route",bundlePath:"app/api/bank-scan/confirm/route"},resolvedPagePath:"C:\\Users\\Gebruiker\\Documents\\GitHub\\I-hate-subscriptions\\src\\app\\api\\bank-scan\\confirm\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:f,staticGenerationAsyncStorage:g,serverHooks:x}=m,h="/api/bank-scan/confirm/route";function y(){return(0,n.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:g})}},95456:(e,r,t)=>{"use strict";t.d(r,{Lz:()=>n});var s=t(53797),a=t(77234),i=t(1926);let n={providers:[(0,a.Z)({clientId:process.env.GOOGLE_CLIENT_ID||"",clientSecret:process.env.GOOGLE_CLIENT_SECRET||""}),(0,s.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"},name:{label:"Name",type:"text",optional:!0},isSignUp:{label:"Is Sign Up",type:"text",optional:!0}},async authorize(e){if(!e?.email||!e?.password)return null;if("true"===e.isSignUp){let r=(0,i.l)(),{data:t}=await r.from("user_profiles").select("*").eq("email",e.email).single();if(t)throw Error("User already exists");let{data:s,error:a}=await r.auth.admin.createUser({email:e.email,password:e.password,email_confirm:!0,user_metadata:{full_name:e.name||e.email.split("@")[0]}});if(a||!s.user)throw Error(a?.message||"Failed to create user");return{id:s.user.id,email:s.user.email,name:e.name||e.email.split("@")[0],isPaid:!1}}{let r=(0,i.l)(),{data:t}=await r.from("user_profiles").select("*").eq("email",e.email).single();if(!t)throw Error("No user found");let{data:s,error:a}=await r.auth.signInWithPassword({email:e.email,password:e.password});if(a||!s.user)throw Error("Invalid credentials");return{id:t.id,email:t.email,name:t.full_name||t.email.split("@")[0],isPaid:t.has_paid||!1}}}})],callbacks:{async jwt({token:e,user:r,account:t}){if(r&&"isPaid"in r&&(e.isPaid=r.isPaid),t?.provider==="google"&&r){let t=(0,i.l)(),{data:s}=await t.from("user_profiles").select("*").eq("email",r.email).single();if(s)e.isPaid=s.has_paid||!1;else{let{data:s,error:a}=await t.auth.admin.createUser({email:r.email,email_confirm:!0,user_metadata:{full_name:r.name||r.email.split("@")[0]}});!a&&s.user&&(e.isPaid=!1)}}return e},session:async({session:e,token:r})=>(e.user&&(e.user.id=r.sub,e.user.isPaid=r.isPaid),e)},pages:{signIn:"/auth/signin"},session:{strategy:"jwt"}}},1926:(e,r,t)=>{"use strict";t.d(r,{l:()=>a});var s=t(72438);let a=()=>(0,s.eI)("https://kumslhaqyummcgytyvxv.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}})}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[276,494,734,70],()=>t(64167));module.exports=s})();