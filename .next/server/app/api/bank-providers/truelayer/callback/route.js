(()=>{var e={};e.id=822,e.ids=[822],e.modules={72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{"use strict";e.exports=require("assert")},78893:e=>{"use strict";e.exports=require("buffer")},84770:e=>{"use strict";e.exports=require("crypto")},17702:e=>{"use strict";e.exports=require("events")},32615:e=>{"use strict";e.exports=require("http")},35240:e=>{"use strict";e.exports=require("https")},98216:e=>{"use strict";e.exports=require("net")},68621:e=>{"use strict";e.exports=require("punycode")},86624:e=>{"use strict";e.exports=require("querystring")},76162:e=>{"use strict";e.exports=require("stream")},82452:e=>{"use strict";e.exports=require("tls")},17360:e=>{"use strict";e.exports=require("url")},21764:e=>{"use strict";e.exports=require("util")},71568:e=>{"use strict";e.exports=require("zlib")},58359:()=>{},93739:()=>{},50332:(e,r,t)=>{"use strict";t.r(r),t.d(r,{originalPathname:()=>g,patchFetch:()=>_,requestAsyncStorage:()=>h,routeModule:()=>m,serverHooks:()=>b,staticGenerationAsyncStorage:()=>y});var a={};t.r(a),t.d(a,{GET:()=>p});var s=t(49303),i=t(88716),n=t(60670),o=t(87070),c=t(75571),l=t(95456);class u{}class d extends u{constructor(){super(),this.name="truelayer",this.supportedCountries=["GB","IE","FR","DE","ES","IT","NL","BE","PT","PL"],this.baseUrl="https://api.truelayer-sandbox.com",this.authUrl="https://auth.truelayer-sandbox.com",this.clientId=process.env.TRUELAYER_CLIENT_ID||"",this.clientSecret=process.env.TRUELAYER_CLIENT_SECRET||"",this.clientId&&this.clientSecret||console.warn("TrueLayer credentials not configured")}isAvailable(e){return this.supportedCountries.includes(e.toUpperCase())}async createLinkToken(e,r="GB"){try{let r=`${process.env.NEXTAUTH_URL}/api/bank-providers/truelayer/callback`,t=`${e}_${Date.now()}`,a=new URL(`${this.authUrl}/`);return a.searchParams.set("response_type","code"),a.searchParams.set("client_id",this.clientId),a.searchParams.set("scope","info accounts balance cards transactions direct_debits standing_orders offline_access"),a.searchParams.set("redirect_uri",r),a.searchParams.set("providers","uk-cs-mock uk-ob-all uk-oauth-all"),a.searchParams.set("state",t),{link_token:a.toString(),expiration:new Date(Date.now()+36e5).toISOString(),request_id:t}}catch(e){throw console.error("TrueLayer createLinkToken error:",e),Error("Failed to create TrueLayer link token")}}async exchangePublicToken(e){try{let r=await fetch(`${this.authUrl}/connect/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"authorization_code",client_id:this.clientId,client_secret:this.clientSecret,redirect_uri:`${process.env.NEXTAUTH_URL}/api/bank-providers/truelayer/callback`,code:e})});if(!r.ok)throw Error(`TrueLayer token exchange failed: ${r.statusText}`);let t=await r.json();return{access_token:t.access_token,request_id:t.refresh_token}}catch(e){throw console.error("TrueLayer exchangePublicToken error:",e),Error("Failed to exchange TrueLayer authorization code")}}async getAccounts(e){try{let r=await fetch(`${this.baseUrl}/data/v1/accounts`,{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!r.ok)throw Error(`TrueLayer getAccounts failed: ${r.statusText}`);return(await r.json()).results.map(e=>({id:e.account_id,name:e.display_name,type:this.mapAccountType(e.account_type),currency:e.currency,provider:this.name}))}catch(e){throw console.error("TrueLayer getAccounts error:",e),Error("Failed to fetch TrueLayer accounts")}}async getTransactions(e,r,t){try{let a=[];for(let s of r){let r=new URL(`${this.baseUrl}/data/v1/accounts/${s}/transactions`);r.searchParams.set("from",t.startDate),r.searchParams.set("to",t.endDate);let i=await fetch(r.toString(),{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!i.ok){console.warn(`Failed to fetch transactions for account ${s}: ${i.statusText}`);continue}let n=(await i.json()).results.map(e=>({id:e.transaction_id,account_id:e.account_id,amount:"DEBIT"===e.transaction_type?-Math.abs(e.amount):Math.abs(e.amount),date:e.timestamp.split("T")[0],description:e.description,merchant_name:e.merchant_name,category:e.transaction_classification||[e.transaction_category],provider:this.name,currency:e.currency,balance:e.running_balance?.amount}));a.push(...n)}return a.sort((e,r)=>new Date(r.date).getTime()-new Date(e.date).getTime())}catch(e){throw console.error("TrueLayer getTransactions error:",e),Error("Failed to fetch TrueLayer transactions")}}async getInstitutions(e){try{return this.getCommonInstitutions(e)}catch(e){return console.error("TrueLayer getInstitutions error:",e),[]}}mapAccountType(e){return({TRANSACTION:"checking",SAVINGS:"savings",CREDIT_CARD:"credit",INVESTMENT:"investment"})[e]||"other"}getProvidersForCountry(e){return({GB:"uk-ob-all uk-oauth-all",IE:"ie-ob-all",FR:"fr-ob-all",DE:"de-ob-all",ES:"es-ob-all",IT:"it-ob-all",NL:"nl-ob-all",BE:"be-ob-all",PT:"pt-ob-all",PL:"pl-ob-all"})[e.toUpperCase()]||"uk-ob-all"}getCommonInstitutions(e){return({GB:[{id:"hsbc-gb",name:"HSBC UK",country:"GB",provider:this.name},{id:"barclays-gb",name:"Barclays",country:"GB",provider:this.name},{id:"lloyds-gb",name:"Lloyds Bank",country:"GB",provider:this.name},{id:"natwest-gb",name:"NatWest",country:"GB",provider:this.name},{id:"santander-gb",name:"Santander UK",country:"GB",provider:this.name}],DE:[{id:"deutsche-bank-de",name:"Deutsche Bank",country:"DE",provider:this.name},{id:"commerzbank-de",name:"Commerzbank",country:"DE",provider:this.name},{id:"ing-de",name:"ING Germany",country:"DE",provider:this.name},{id:"dkb-de",name:"DKB",country:"DE",provider:this.name}],FR:[{id:"bnp-paribas-fr",name:"BNP Paribas",country:"FR",provider:this.name},{id:"credit-agricole-fr",name:"Cr\xe9dit Agricole",country:"FR",provider:this.name},{id:"societe-generale-fr",name:"Soci\xe9t\xe9 G\xe9n\xe9rale",country:"FR",provider:this.name}],NL:[{id:"ing-nl",name:"ING Netherlands",country:"NL",provider:this.name},{id:"abn-amro-nl",name:"ABN AMRO",country:"NL",provider:this.name},{id:"rabobank-nl",name:"Rabobank",country:"NL",provider:this.name}]})[e.toUpperCase()]||[]}}async function p(e){try{let r=await (0,c.getServerSession)(l.Lz);if(!r?.user?.email)return o.NextResponse.redirect(new URL("/auth/signin",e.url));let{searchParams:t}=new URL(e.url),a=t.get("code"),s=t.get("state"),i=t.get("error");if(i)return console.error("TrueLayer OAuth error:",i),o.NextResponse.redirect(new URL("/dashboard?bank_error=oauth_failed",e.url));if(!a||!s)return o.NextResponse.redirect(new URL("/dashboard?bank_error=missing_params",e.url));let[n]=s.split("_"),u=new d;try{await u.exchangePublicToken(a);let r=new URL("/dashboard",e.url);return r.searchParams.set("bank_connected","success"),r.searchParams.set("provider","truelayer"),o.NextResponse.redirect(r)}catch(r){return console.error("TrueLayer token exchange error:",r),o.NextResponse.redirect(new URL("/dashboard?bank_error=token_exchange_failed",e.url))}}catch(r){return console.error("TrueLayer callback error:",r),o.NextResponse.redirect(new URL("/dashboard?bank_error=callback_failed",e.url))}}let m=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/bank-providers/truelayer/callback/route",pathname:"/api/bank-providers/truelayer/callback",filename:"route",bundlePath:"app/api/bank-providers/truelayer/callback/route"},resolvedPagePath:"C:\\Users\\Gebruiker\\Documents\\GitHub\\I-hate-subscriptions\\src\\app\\api\\bank-providers\\truelayer\\callback\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:h,staticGenerationAsyncStorage:y,serverHooks:b}=m,g="/api/bank-providers/truelayer/callback/route";function _(){return(0,n.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:y})}},95456:(e,r,t)=>{"use strict";t.d(r,{Lz:()=>n});var a=t(53797),s=t(77234),i=t(1926);let n={providers:[(0,s.Z)({clientId:process.env.GOOGLE_CLIENT_ID||"",clientSecret:process.env.GOOGLE_CLIENT_SECRET||""}),(0,a.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"},name:{label:"Name",type:"text",optional:!0},isSignUp:{label:"Is Sign Up",type:"text",optional:!0}},async authorize(e){if(!e?.email||!e?.password)return null;if("true"===e.isSignUp){let r=(0,i.l)(),{data:t}=await r.from("user_profiles").select("*").eq("email",e.email).single();if(t)throw Error("User already exists");let{data:a,error:s}=await r.auth.admin.createUser({email:e.email,password:e.password,email_confirm:!0,user_metadata:{full_name:e.name||e.email.split("@")[0]}});if(s||!a.user)throw Error(s?.message||"Failed to create user");return{id:a.user.id,email:a.user.email,name:e.name||e.email.split("@")[0],isPaid:!1}}{let r=(0,i.l)(),{data:t}=await r.from("user_profiles").select("*").eq("email",e.email).single();if(!t)throw Error("No user found");let{data:a,error:s}=await r.auth.signInWithPassword({email:e.email,password:e.password});if(s||!a.user)throw Error("Invalid credentials");return{id:t.id,email:t.email,name:t.full_name||t.email.split("@")[0],isPaid:t.has_paid||!1}}}})],callbacks:{async jwt({token:e,user:r,account:t}){if(r&&"isPaid"in r&&(e.isPaid=r.isPaid),t?.provider==="google"&&r){let t=(0,i.l)(),{data:a}=await t.from("user_profiles").select("*").eq("email",r.email).single();if(a)e.isPaid=a.has_paid||!1;else{let{data:a,error:s}=await t.auth.admin.createUser({email:r.email,email_confirm:!0,user_metadata:{full_name:r.name||r.email.split("@")[0]}});!s&&a.user&&(e.isPaid=!1)}}return e},session:async({session:e,token:r})=>(e.user&&(e.user.id=r.sub,e.user.isPaid=r.isPaid),e)},pages:{signIn:"/auth/signin"},session:{strategy:"jwt"}}},1926:(e,r,t)=>{"use strict";t.d(r,{l:()=>s});var a=t(72438);let s=()=>(0,a.eI)("https://kumslhaqyummcgytyvxv.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}})}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[276,494,734,70],()=>t(50332));module.exports=a})();