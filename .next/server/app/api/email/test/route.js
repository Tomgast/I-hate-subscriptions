"use strict";(()=>{var e={};e.id=854,e.ids=[854],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},68621:e=>{e.exports=require("punycode")},86624:e=>{e.exports=require("querystring")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},86657:(e,r,s)=>{s.r(r),s.d(r,{originalPathname:()=>f,patchFetch:()=>b,requestAsyncStorage:()=>x,routeModule:()=>m,serverHooks:()=>h,staticGenerationAsyncStorage:()=>g});var t={};s.r(t),s.d(t,{POST:()=>p});var i=s(49303),n=s(88716),a=s(60670),o=s(87070),l=s(75571),u=s(95456),c=s(77865),d=s(23737);async function p(e){try{let r=await (0,l.getServerSession)(u.Lz);if(!r?.user?.email)return o.NextResponse.json({error:"Unauthorized"},{status:401});let{type:s}=await e.json(),t=r.user.name||r.user.email.split("@")[0],i=!1,n="";switch(s){case"welcome":i=await c.y.sendWelcomeEmail(r.user.email,t),n="Welcome email sent";break;case"upgrade":i=await c.y.sendUpgradeConfirmation(r.user.email,t),n="Upgrade confirmation email sent";break;case"reminder":i=await d.z2.sendTestReminder(r.user.email,t,"Netflix",15.99,"EUR"),n="Test renewal reminder sent";break;case"bank-scan":i=await c.y.sendBankScanComplete(r.user.email,t,3),n="Bank scan completion email sent";break;default:return o.NextResponse.json({error:"Invalid email type. Use: welcome, upgrade, reminder, or bank-scan"},{status:400})}if(i)return o.NextResponse.json({message:n,recipient:r.user.email,type:s});return o.NextResponse.json({error:`Failed to send ${s} email`},{status:500})}catch(e){return console.error("Test email error:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}let m=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/email/test/route",pathname:"/api/email/test",filename:"route",bundlePath:"app/api/email/test/route"},resolvedPagePath:"C:\\Users\\Gebruiker\\Documents\\GitHub\\I-hate-subscriptions\\src\\app\\api\\email\\test\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:x,staticGenerationAsyncStorage:g,serverHooks:h}=m,f="/api/email/test/route";function b(){return(0,a.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:g})}},23737:(e,r,s)=>{s.d(r,{z2:()=>n});var t=s(77865);class i{constructor(){this.reminders=new Map,this.loadReminders()}scheduleRenewalReminders(e,r,s,t,i,n,a,o,l=[7,3,1]){let u=`${e}_${t}`;this.reminders.set(u,{id:u,userId:e,userEmail:r,userName:s,subscriptionId:t,subscriptionName:i,amount:n,currency:a,renewalDate:o,reminderDays:l,isActive:!0}),console.log(`üìÖ Scheduled reminders for ${i} (${l.join(", ")} days before renewal)`)}cancelReminders(e,r){let s=`${e}_${r}`,t=this.reminders.get(s);t&&(t.isActive=!1,console.log(`‚ùå Cancelled reminders for ${t.subscriptionName}`))}async processDueReminders(){let e=new Date,r=e.toISOString().split("T")[0];for(let[s,i]of Array.from(this.reminders.entries()))if(i.isActive)try{let n=new Date(i.renewalDate),a=Math.ceil((n.getTime()-e.getTime())/864e5);if(i.reminderDays.includes(a)){if(i.lastSent===r)continue;await t.y.sendSubscriptionReminder(i.userEmail,{userName:i.userName,subscriptionName:i.subscriptionName,amount:i.amount,currency:i.currency,renewalDate:i.renewalDate,daysUntilRenewal:a,manageUrl:`${process.env.NEXTAUTH_URL}/subscriptions/${i.subscriptionId}`,cancelUrl:`${process.env.NEXTAUTH_URL}/subscriptions/${i.subscriptionId}/cancel`})?(i.lastSent=r,console.log(`‚úÖ Sent ${a}-day reminder for ${i.subscriptionName} to ${i.userEmail}`)):console.error(`‚ùå Failed to send reminder for ${i.subscriptionName}`)}a<-1&&(this.reminders.delete(s),console.log(`üóëÔ∏è Cleaned up expired reminder for ${i.subscriptionName}`))}catch(e){console.error(`Error processing reminder for ${i.subscriptionName}:`,e)}}getUserReminders(e){return Array.from(this.reminders.values()).filter(r=>r.userId===e&&r.isActive)}updateReminderSettings(e,r,s){let t=`${e}_${r}`,i=this.reminders.get(t);return!!i&&(i.reminderDays=s,console.log(`‚öôÔ∏è Updated reminder settings for ${i.subscriptionName}: ${s.join(", ")} days`),!0)}async sendTestReminder(e,r,s="Netflix",i=15.99,n="EUR"){let a=new Date;return a.setDate(a.getDate()+3),await t.y.sendSubscriptionReminder(e,{userName:r,subscriptionName:s,amount:i,currency:n,renewalDate:a.toISOString().split("T")[0],daysUntilRenewal:3,manageUrl:`${process.env.NEXTAUTH_URL}/dashboard`,cancelUrl:`${process.env.NEXTAUTH_URL}/help`})}loadReminders(){console.log("\uD83D\uDCE7 Email scheduler initialized")}saveReminders(){console.log(`üíæ Saved ${this.reminders.size} email reminders`)}}let n=new i}};var r=require("../../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),t=r.X(0,[276,494,734,70,245,563],()=>s(86657));module.exports=t})();